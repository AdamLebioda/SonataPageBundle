/**
 *
 * This file is part of the Sonata package.
 *
 * (c) Thomas Rabaix <thomas.rabaix@sonata-project.org>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 *
 * generated on: Fri Oct 31 2014 14:07:27 GMT+0100 (CET)
 * revision:     de86c7818f4133916359232a38f24b52b30d9f59
 *
 */
!function(e,t){function n(e){"undefined"==typeof t.admin&&Admin.shared_setup(e)}var o=function(t){this.pageId=t,this.$container=e(".page-composer"),this.$dynamicArea=e(".page-composer__dyn-content"),this.$pagePreview=e(".page-composer__page-preview"),this.$containerPreviews=this.$pagePreview.find(".page-composer__page-preview__container"),this.routes={},this.csrfTokens={},this.templates={childBlock:'<a class="page-composer__container__child__edit" href="%edit_url%"><h4>%name%</h4><small>%type%</small><span class="page-composer__container__child__toggle"><span class="fa fa-chevron-down"></span><span class="fa fa-chevron-up"></span></span></a><div class="page-composer__container__child__right"><div class="page-composer__container__child__remove"><a class="badge" href="%remove_url%">Remove <i class="fa fa-times"></i> </a><span class="page-composer__container__child__remove__confirm">Confirm Delete? <span class="yes">yes</span> <span class="cancel">cancel</span></span></div><div class="page-composer__container__child__switch-enabled" data-label-enable="enable" data-label-disable="disable"><a class="badge bg-yellow" href="%switchenable_url%">Disable</a></div><div class="page-composer__container__child__enabled"><small class="badge bg-green"><i class="fa fa-check"></i></small></div></div><div class="page-composer__container__child__content"></div><div class="page-composer__container__child__loader"><span>loading</span></div>'},this.bindPagePreviewHandlers(),this.bindOrphansHandlers();var n=this,o=e(this);o.on("containerclick",function(e){n.loadContainer(e.$container)}),o.on("containerloaded",this.handleContainerLoaded),o.on("blockcreated",this.handleBlockCreated),o.on("blockremoved",this.handleBlockRemoved),o.on("blockcreateformloaded",this.handleBlockCreateFormLoaded),o.on("blockpositionsupdate",this.handleBlockPositionsUpdate),o.on("blockeditformloaded",this.handleBlockEditFormLoaded),o.on("blockparentswitched",this.handleBlockParentSwitched)};o.prototype={setRoute:function(e,t){this.routes[e]=t},getRouteUrl:function(e,t){if(!this.routes[e])throw new Error('Route "'+e+'" does not exist');var n=this.routes[e];for(var o in t)n=n.replace(new RegExp(o),t[o]);return n},renderTemplate:function(e,t){if(!this.templates[e])throw new Error('Template "'+e+'" does not exist');var n=this.templates[e];for(var o in t)n=n.replace(new RegExp("%"+o+"%"),t[o]);return n},isFormControlTypeByName:function(e,t){if("undefined"!=typeof e){var n=e.length,o="["+t+"]",i=e.lastIndexOf(o);return n-=o.length,-1!==i&&i===n}return!1},handleBlockCreated:function(e){var t=this.renderTemplate("childBlock",{name:e.blockName,type:e.blockType,edit_url:this.getRouteUrl("block_edit",{BLOCK_ID:e.blockId}),remove_url:this.getRouteUrl("block_remove",{BLOCK_ID:e.blockId}),switchenable_url:this.getRouteUrl("block_switch_enable",{BLOCK_ID:e.blockId})});e.$childBlock.attr("data-block-id",e.blockId),e.$childBlock.attr("data-parent-block-id",e.parentId),e.$childBlock.html(t),this.controlChildBlock(e.$childBlock);var n=this.getContainerChildCountFromList(e.parentId);null!==n&&this.updateChildCount(e.parentId,n)},handleBlockRemoved:function(e){var t=this.getContainerChildCountFromList(e.parentId);null!==t&&this.updateChildCount(e.parentId,t)},containerNotification:function(t,n,o){var i=this.$dynamicArea.find(".page-composer__container__view__notice");if(1===i.length)if(this.containerNotificationTimer&&clearTimeout(this.containerNotificationTimer),i.removeClass("persist success error"),n&&i.addClass(n),i.text(t),i.show(),o!==!0)this.containerNotificationTimer=setTimeout(function(){i.hide().empty()},2e3);else{var a=e('<span class="close-notice">x</span>');a.on("click",function(){i.hide().empty()}),i.addClass("persist"),i.append(a)}},handleBlockPositionsUpdate:function(t){var n=this;this.containerNotification("saving block positionsâ€¦"),e.ajax({url:this.getRouteUrl("save_blocks_positions"),type:"POST",data:{disposition:t.disposition},success:function(e){e.result&&"ok"===e.result&&n.containerNotification("block positions saved","success")},error:function(){n.containerNotification("an error occured while saving block positions","error",!0)}})},handleBlockParentSwitched:function(t){var n=e(".block-preview-"+t.previousParentId),o=n.find(".child-count"),i=parseInt(o.text().trim(),10),a=e(".block-preview-"+t.newParentId),r=a.find(".child-count"),c=parseInt(r.text().trim(),10);this.updateChildCount(t.previousParentId,i-1),this.updateChildCount(t.newParentId,c+1)},getContainerChildCountFromList:function(t){var n=this.$dynamicArea.find(".block-view-"+t);if(0===n.length)return null;var o=n.find(".page-composer__container__child"),i=0;return o.each(function(){var t=e(this),n=t.attr("data-block-id");"undefined"!=typeof n&&i++}),i},updateChildCount:function(t,n){var o=e(".block-preview-"+t),i=e(".block-view-"+t);o.length>0&&o.find(".child-count").text(n),i.length>0&&i.find(".page-composer__container__child-count span").text(n)},handleBlockCreateFormLoaded:function(t){var o=this,i=this.$dynamicArea.find(".page-composer__container__children"),a=this.$dynamicArea.find(".page-composer__container__main-edition-area");if(t.container){var r=t.container,c=r.find(".page-composer__container__child__content");c.html(t.response)}else{var r=e(['<li class="page-composer__container__child">','<a class="page-composer__container__child__edit">','<h4 class="page-composer__container__child__name">','<input type="text" class="page-composer__container__child__name__input" />',"</h4>","</a>",'<div class="page-composer__container__child__right">','<span class="badge">'+t.blockType+"</span>","</div>",'<div class="page-composer__container__child__content">',"</div>","</li>"].join("")),c=r.find(".page-composer__container__child__content");c.append(t.response),i.append(r),c.show()}var s,l,d,p=r.find("form"),h=p.attr("action"),_=p.attr("method"),u=p.find("input, select, textarea"),f=p.find(".form-actions"),m=this.$dynamicArea.find(".page-composer__container__child__name");n(p),e(document).scrollTo(r,200),a.show(),u.each(function(){var n=e(this),a=n.attr("name");o.isFormControlTypeByName(a,"name")?(s=n,m.find(".page-composer__container__child__name__input").bind("propertychange keyup input paste",function(){s.val(e(this).val())})):o.isFormControlTypeByName(a,"parent")?(l=n,l.val(t.containerId),l.parent().parent().hide()):o.isFormControlTypeByName(a,"position")&&(d=n,d.val(i.find("> *").length),d.closest(".form-group").hide())}),f.each(function(){var t=e(this),n=e('<span class="btn btn-warning">cancel</span>');n.on("click",function(t){t.preventDefault(),r.remove(),e(document).scrollTo(o.$dynamicArea,200)}),t.append(n)}),p.on("submit",function(i){i.preventDefault();var a=s.val();return""===a&&(a=t.blockType),e.ajax({url:h+"&"+e.param({composer:1}),data:p.serialize(),type:_,success:function(i){if(i.result&&"ok"===i.result&&i.objectId){var s=e.Event("blockcreated");s.$childBlock=r,s.parentId=t.containerId,s.blockId=i.objectId,s.blockName=a,s.blockType=t.blockType,e(o).trigger(s)}else{var l=e.Event("blockcreateformloaded");l.response=i,l.containerId=t.containerId,l.blockType=t.blockType,l.container=r,e(o).trigger(l),n(c)}}}),!1})},toggleChildBlock:function(e){var t="page-composer__container__child--expanded",n=this.$dynamicArea.find(".page-composer__container__child"),o=e.find(".page-composer__container__child__name"),i=o.find(".page-composer__container__child__name__input");e.hasClass(t)?(e.removeClass(t),o.has(".page-composer__container__child__name__input")&&o.html(i.val())):(n.not(e).removeClass(t),e.addClass(t))},handleBlockEditFormLoaded:function(t){var o,i,a=this,r=t.$block.find(".page-composer__container__child__edit h4"),c=t.$block.find(".page-composer__container__child__content"),s=t.$block.find(".page-composer__container__child__loader"),l=c.find("form"),d=l.attr("action"),p=l.attr("method"),h=t.$block.find(".page-composer__container__child__edit small").text().trim();l.find("input").each(function(){var t=e(this),n=t.attr("name");a.isFormControlTypeByName(n,"name")?(o=t,r.html('<input type="text" class="page-composer__container__child__name__input" value="'+r.text()+'">'),$input=r.find("input"),$input.bind("propertychange keyup input paste",function(){o.val($input.val())}),$input.on("click",function(e){e.stopPropagation(),e.preventDefault()})):a.isFormControlTypeByName(n,"position")&&(i=t,i.closest(".form-group").hide())}),l.on("submit",function(i){return i.preventDefault(),s.show(),e.ajax({url:d,data:l.serialize(),type:p,success:function(i){if(s.hide(),i.result&&"ok"===i.result)"undefined"!=typeof o&&r.text(""!==o.val()?o.val():h),t.$block.removeClass("page-composer__container__child--expanded"),c.empty();else{c.html(i);var l=e.Event("blockeditformloaded");l.$block=t.$block,e(a).trigger(l),n(c)}}}),!1})},controlChildBlock:function(t){var o=this,i=t.find(".page-composer__container__child__content"),a=t.find(".page-composer__container__child__loader"),r=t.find(".page-composer__container__child__edit"),c=r.attr("href"),s=t.find(".page-composer__container__child__remove"),l=s.find("a"),d=s.find(".page-composer__container__child__remove__confirm"),p=d.find(".cancel"),h=d.find(".yes"),_=l.attr("href"),u=t.find(".page-composer__container__child__switch-enabled"),f=u.attr("data-label-enable"),m=u.attr("data-label-disable"),g=u.find("a"),v=g.find("i"),b=t.find(".page-composer__container__child__enabled"),k=b.find("small"),y=b.find("i"),C=g.attr("href"),w=parseInt(t.attr("data-parent-block-enabled"),1);parentId=parseInt(t.attr("data-parent-block-id"),10),r.click(function(r){return r.preventDefault(),i.find("form").length>0?void o.toggleChildBlock(t):(a.show(),void e.ajax({url:c,success:function(r){i.html(r);var c=e.Event("blockeditformloaded");c.$block=t,e(o).trigger(c),n(i),a.hide(),o.toggleChildBlock(t)}}))}),g.on("click",function(n){n.preventDefault(),e.ajax({url:C,type:"POST",data:{_sonata_csrf_token:o.csrfTokens.switchEnabled,enabled:!w},success:function(n){if(n.status&&"OK"===n.status){if(t.attr("data-parent-block-enabled",!w),w=!w,g.toggleClass("bg-yellow bg-green"),v.toggleClass("fa-toggle-off fa-toggle-on"),g.html(w?m:f),k.toggleClass("bg-yellow bg-green"),y.toggleClass("fa-times fa-check"),t.has("form")){var i=t.find("form"),a=i.find("input");a.each(function(){var t=e(this),n=t.attr("name");o.isFormControlTypeByName(n,"enabled")&&t.val(parseInt(!w))})}}else o.containerNotification("an error occured while saving block enabled status","error",!0)},error:function(){o.containerNotification("an error occured while saving block enabled status","error",!0)}})}),l.on("click",function(e){e.preventDefault(),l.hide(),d.show()}),h.on("click",function(n){n.preventDefault(),e.ajax({url:_,type:"POST",data:{_method:"DELETE",_sonata_csrf_token:o.csrfTokens.remove},success:function(n){if(n.result&&"ok"===n.result){t.remove();var i=e.Event("blockremoved");i.parentId=parentId,e(o).trigger(i)}}})}),p.on("click",function(e){e.preventDefault(),d.hide(),l.show()})},handleContainerLoaded:function(t){var o=this,i=this.$dynamicArea.find(".page-composer__container__children"),a=this.$dynamicArea.find(".page-composer__container__child"),r=this.$dynamicArea.find(".page-composer__block-type-selector"),c=r.find(".page-composer__block-type-selector__loader"),s=r.find("select"),l=r.find(".page-composer__block-type-selector__confirm"),d=l.attr("href");n(this.$dynamicArea),l.on("click",function(n){n.preventDefault(),c.css("display","inline-block");var i=s.val();e.ajax({url:d,data:{type:i},success:function(n){c.hide();var a=e.Event("blockcreateformloaded");a.response=n,a.containerId=t.containerId,a.blockType=i,e(o).trigger(a)}})}),i.sortable({revert:!0,cursor:"move",revertDuration:200,delay:200,helper:function(t,n){{var o=e(n),i=o.find(".page-composer__container__child__edit h4").text().trim();o.find(".page-composer__container__child__edit small").text().trim()}return o.removeClass("page-composer__container__child--expanded"),e('<div class="page-composer__container__child__helper"><h4>'+i+"</h4></div>")},update:function(){var t=[];if(i.find(".page-composer__container__child").each(function(n){var i=e(this),a=i.attr("data-parent-block-id"),r=i.attr("data-block-id");"undefined"!=typeof r&&t.push({id:parseInt(r,10),position:n,parent_id:parseInt(a,10),page_id:o.pageId})}),t.length>0){var n=e.Event("blockpositionsupdate");n.disposition=t,e(o).trigger(n)}}}),a.each(function(){o.controlChildBlock(e(this))})},bindPagePreviewHandlers:function(){var t=this;this.$containerPreviews.each(function(){var n=e(this);n.on("click",function(o){o.preventDefault();var i=e.Event("containerclick");i.$container=n,e(t).trigger(i)})}).droppable({hoverClass:"hover",tolerance:"pointer",revert:!0,connectToSortable:".page-composer__container__children",drop:function(n,o){var i=o.draggable.attr("data-block-id");if("undefined"!=typeof i){o.helper.remove();var a=e(this),r=parseInt(o.draggable.attr("data-parent-block-id"),10),c=parseInt(a.attr("data-block-id"),10);i=parseInt(i,10),r!==c&&(a.addClass("dropped"),a.on("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(){a.removeClass("dropped")}),e.ajax({url:t.getRouteUrl("block_switch_parent"),data:{block_id:i,parent_id:c},success:function(n){if(n.result&&"ok"===n.result){o.draggable.remove();var a=e.Event("blockparentswitched");a.previousParentId=r,a.newParentId=c,a.blockId=i,e(t).trigger(a)}}}))}}}),this.$containerPreviews.length>0&&this.loadContainer(this.$containerPreviews.eq(0))},bindOrphansHandlers:function(){var t=this;this.$container.find(".page-composer__orphan-container").each(function(){var n=e(this);n.on("click",function(o){o.preventDefault();var i=e.Event("containerclick");i.$container=n,e(t).trigger(i)})})},loadContainer:function(t){var n=t.attr("href"),o=t.attr("data-block-id"),i=this;this.$dynamicArea.empty(),this.$containerPreviews.removeClass("active"),this.$container.find(".page-composer__orphan-container").removeClass("active"),t.addClass("active"),e.ajax({url:n,success:function(t){i.$dynamicArea.html(t),e(document).scrollTo(i.$dynamicArea,200,{offset:{top:-100}});var n=e.Event("containerloaded");n.containerId=o,e(i).trigger(n)}})}},t.PageComposer=o}(jQuery,window);var Sonata=Sonata||{};Sonata.Page={debug:!1,blocks:[],containers:[],data:[],blockSelector:".cms-block",containerSelector:".cms-container",dropPlaceHolderClass:"cms-block-placeholder",dropPlaceHolderSize:100,dropZoneClass:"cms-container-drop-zone",blockHoverClass:"cms-block-hand-over",url:{block_save_position:null,block_edit:null},init:function(e){e=e||[];for(property in e)this[property]=e[property];this.initInterface(),this.initBlocks(),this.initContainers(),this.initBlockData()},initInterface:function(){jQuery("#page-action-enabled-edit").change(jQuery.proxy(this.toggleEditMode,this)),jQuery("#page-action-save-position").click(jQuery.proxy(this.saveBlockLayout,this))},initBlocks:function(){this.blocks=jQuery(this.blockSelector),this.blocks.mouseover(jQuery.proxy(this.handleBlockHover,this)),this.blocks.dblclick(jQuery.proxy(this.handleBlockClick,this))},initContainers:function(){this.containers=jQuery(this.containerSelector),this.containers.sortable({connectWith:this.containerSelector,items:this.blockSelector,placeholder:this.dropPlaceHolderClass,helper:"clone",dropOnEmpty:!0,forcePlaceholderSize:this.dropPlaceHolderSize,opacity:1,cursor:"move",start:jQuery.proxy(this.startContainerSort,this),stop:jQuery.proxy(this.stopContainerSort,this)}).sortable("disable")},initBlockData:function(){this.data=this.buildBlockData()},startContainerSort:function(){this.containers.addClass(this.dropZoneClass),this.containers.append(jQuery('<div class="cms-fake-block">&nbsp;</div>'))},stopContainerSort:function(){this.containers.removeClass(this.dropZoneClass),jQuery("div.cms-fake-block").remove(),this.refreshLayers()},handleBlockClick:function(e){var t=e.currentTarget,n=jQuery(t).attr("data-id");window.open(this.url.block_edit.replace(/BLOCK_ID/,n),"_newtab"),e.preventDefault(),e.stopPropagation()},handleBlockHover:function(e){this.blocks.removeClass(this.blockHoverClass),jQuery(this).addClass(this.blockHoverClass),e.stopPropagation()},toggleEditMode:function(e){e&&e.currentTarget.checked?(jQuery("body").addClass("cms-edit-mode"),jQuery(".cms-container").sortable("enable"),this.buildLayers()):(jQuery("body").removeClass("cms-edit-mode"),jQuery("div.cms-container").sortable("disable"),this.removeLayers()),e.preventDefault(),e.stopPropagation()},buildLayers:function(){this.blocks.each(function(){var e,t=jQuery(this),n=t.attr("data-role")||"block",o=t.attr("data-name")||"missing data-name",i=(t.attr("data-id")||"missing data-id",[]);i.push("cms-layout-layer"),i.push("cms-layout-role-"+n),e=jQuery('<div class="'+i.join(" ")+'" ></div>'),e.css({position:"absolute",left:0,top:0,width:"100%",height:"100%",zIndex:2}),title=jQuery('<div class="cms-layout-title"></div>'),title.css({position:"absolute",left:0,top:0,zIndex:2}),title.html("<span>"+o+"</span>"),e.append(title),t.prepend(e)})},removeLayers:function(){jQuery(".cms-layout-layer").remove()},refreshLayers:function(){jQuery(".cms-layout-layer").each(function(){var e=jQuery(this),t=e.parent();e.css("width",t.width()),e.css("height",t.height())})},buildBlockData:function(){var e=[];return this.blocks.each(jQuery.proxy(function(t,n){var o=this.buildSingleBlockData(n);o&&e.push(o)},this)),e.sort(function(e,t){return e.page_id==t.page_id?e.parent_id==t.parent_id?e.position-t.position:e.parent_id-t.parent_id:e.page_id-t.page_id}),e},buildSingleBlockData:function(e){var t,n,o,i,a,r,c;return t=jQuery(e),(n=t.attr("data-id"))?(o=this.findParentContainer(t))?(i=jQuery(o).attr("data-id"),(root=this.findRootContainer(t))?(a=jQuery(root).attr("data-page-id"),r=t.prevAll(this.blockSelector+"[data-id]"),c=r.length+1,n&&i?{id:n,position:c,parent_id:i,page_id:a}:void 0):void this.log("Block "+n+" has no root but has a parent, should never happen!")):void this.log("Block "+n+" has no parent, it must be a root container, ignored"):void this.log("Block has no data-id, ignored !")},buildDiffBlockData:function(e,t){var n=[];return jQuery.map(e,function(e){var o;o=jQuery.grep(t,function(t){return e.id!=t.id?!1:e.position!=t.position||e.parent_id!=t.parent_id||e.page_id!=t.page_id?!0:void 0}),o&&o[0]&&n.push(o[0])}),n},findParentContainer:function(e){var t,n;return t=jQuery(e).parents(this.containerSelector+"[data-id]"),n=t.get(0)},findRootContainer:function(e){var t,n;return t=jQuery(e).parents(this.containerSelector+"[data-id]"),n=t.get(-1)},saveBlockLayout:function(e){var t;return e.preventDefault(),e.stopPropagation(),t=this.buildDiffBlockData(this.data,this.buildBlockData()),0==t.length?void alert("No changes found."):(jQuery.each(t,jQuery.proxy(function(e,t){this.log("Update block "+t.id+" (Page "+t.page_id+"), parent "+t.parent_id+", at position "+t.position+")")},this)),void jQuery.ajax({type:"POST",url:this.url.block_save_position,data:{disposition:t},dataType:"json",success:jQuery.proxy(function(e){"ok"==e.result?(alert("Block ordering saved!"),this.initBlockData()):(this.log(e),alert("Server could not save block ordering!"))},this),error:jQuery.proxy(function(e,t,n){this.log("Unable to save block ordering: "+n),this.log(t),this.log(e)},this)}))},log:function(){if(this.debug)try{console.log(arguments)}catch(e){}}},function(e){function t(t,o){this.element=t,this.options=e.extend({},i,o),this._defaults=i,this._name=n,this.init()}var n="treeView",o=".js-treeview",i={togglersAttribute:"[data-treeview-toggler]",toggledState:"is-toggled"};t.prototype={init:function(){this.setElements(),this.setEvents()},setElements:function(){this.$element=e(this.element),this.$togglers=this.$element.find(this.options.togglersAttribute)},setEvents:function(){this.$togglers.on("click",e.proxy(this.toggle,this))},toggle:function(t){var n=e(t.currentTarget),o=n.parent();o.toggleClass(this.options.toggledState),o.next("ul").slideToggle()}},e.fn[n]=function(o){return this.each(function(){e.data(this,"plugin_"+n)||e.data(this,"plugin_"+n,new t(this,o))})},e(function(){e(o)[n]()})}(jQuery,window,document);